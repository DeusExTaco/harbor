name: Harbor CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

# Comprehensive permissions for all workflow operations
permissions:
  actions: read
  contents: write  # Enhanced: needed for release creation
  security-events: write
  pull-requests: write
  issues: write
  packages: write

env:
  # Global environment variables
  HARBOR_VERSION: "0.1.0-alpha.3"
  HARBOR_MILESTONE: "M0"
  REGISTRY_IMAGE_DOCKERHUB: dextaco/harbor
  REGISTRY_IMAGE_GHCR: ghcr.io/deusextaco/harbor

jobs:
  # =============================================================================
  # Stage 1: Parallel Static Analysis & Fast Checks
  # =============================================================================

  # Fast code quality checks (runs immediately)
  code-quality:
    name: Code Quality & Linting
    uses: ./.github/workflows/test.yml
    secrets: inherit # pragma: allowlist secret
    with:
      stage: "quality"

  # Static security analysis (runs in parallel with quality)
  static-security:
    name: Static Security Analysis
    uses: ./.github/workflows/codeql.yml
    secrets: inherit # pragma: allowlist secret

  # Dependency scanning (runs in parallel)
  dependency-security:
    name: Dependency Security
    uses: ./.github/workflows/dependency-review.yml
    secrets: inherit # pragma: allowlist secret

  # =============================================================================
  # Stage 2: Comprehensive Test Suite (After Quality Gate)
  # =============================================================================

  test-suite:
    name: Full Test Suite
    needs: [code-quality]  # Wait for linting to pass
    uses: ./.github/workflows/test.yml
    secrets: inherit # pragma: allowlist secret
    with:
      stage: "full-tests"

  # =============================================================================
  # Stage 3: Build Configuration (Determine build strategy)
  # =============================================================================

  build-config:
    name: Build Configuration
    runs-on: ubuntu-latest
    needs: [test-suite, static-security, dependency-security]
    if: |
      always() &&
      needs.test-suite.outputs.tests-passed == 'true' &&
      (needs.static-security.result == 'success' || needs.static-security.result == 'skipped') &&
      (needs.dependency-security.result == 'success' || needs.dependency-security.result == 'skipped')

    outputs:
      should-build: ${{ steps.config.outputs.should-build }}
      is-release: ${{ steps.config.outputs.is-release }}
      docker-tags: ${{ steps.config.outputs.docker-tags }}
      ghcr-tags: ${{ steps.config.outputs.ghcr-tags }}
      version: ${{ steps.config.outputs.version }}
      milestone: ${{ steps.config.outputs.milestone }}
      is-prerelease: ${{ steps.config.outputs.is-prerelease }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure build strategy
        id: config
        run: |
          # Extract version from app/__init__.py (source of truth)
          if [ -f "app/__init__.py" ]; then
            VERSION=$(python -c "
          import re
          with open('app/__init__.py', 'r') as f:
              content = f.read()
              match = re.search(r'__version__ = [\"']([^\"']+)[\"']', content)
              if match:
                  print(match.group(1))
          " || echo "${{ env.HARBOR_VERSION }}")

            # Also extract milestone from app/__init__.py
            MILESTONE=$(python -c "
          import re
          with open('app/__init__.py', 'r') as f:
              content = f.read()
              match = re.search(r'__milestone__ = [\"']([^\"']+)[\"']', content)
              if match:
                  print(match.group(1))
          " || echo "${{ env.HARBOR_MILESTONE }}")
          else
            # Fallback to environment variables
            VERSION="${{ env.HARBOR_VERSION }}"
            MILESTONE="${{ env.HARBOR_MILESTONE }}"
          fi

          # Determine if this is a release (tag push)
          if [[ "${{ github.ref_type }}" == "tag" && "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is-release=true" >> $GITHUB_OUTPUT
            echo "should-build=true" >> $GITHUB_OUTPUT

            # Use version from tag
            VERSION="${{ github.ref_name }}"  # e.g., v0.1.0-alpha.3
            VERSION_CLEAN="${VERSION#v}"      # Remove 'v' prefix
            echo "version=$VERSION_CLEAN" >> $GITHUB_OUTPUT
            echo "milestone=$MILESTONE" >> $GITHUB_OUTPUT

            # Check if prerelease
            if [[ "$VERSION_CLEAN" =~ (alpha|beta|rc|dev) ]]; then
              echo "is-prerelease=true" >> $GITHUB_OUTPUT
            else
              echo "is-prerelease=false" >> $GITHUB_OUTPUT
            fi

            # Set release tags
            echo "docker-tags=${{ env.REGISTRY_IMAGE_DOCKERHUB }}:$VERSION_CLEAN,${{ env.REGISTRY_IMAGE_DOCKERHUB }}:latest" >> $GITHUB_OUTPUT
            echo "ghcr-tags=${{ env.REGISTRY_IMAGE_GHCR }}:$VERSION_CLEAN,${{ env.REGISTRY_IMAGE_GHCR }}:latest" >> $GITHUB_OUTPUT

            echo "ğŸ·ï¸ RELEASE BUILD for $VERSION (milestone: $MILESTONE)"

          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "is-release=false" >> $GITHUB_OUTPUT
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "milestone=$MILESTONE" >> $GITHUB_OUTPUT
            echo "is-prerelease=false" >> $GITHUB_OUTPUT

            # Set development tags
            echo "docker-tags=${{ env.REGISTRY_IMAGE_DOCKERHUB }}:latest,${{ env.REGISTRY_IMAGE_DOCKERHUB }}:main" >> $GITHUB_OUTPUT
            echo "ghcr-tags=${{ env.REGISTRY_IMAGE_GHCR }}:latest,${{ env.REGISTRY_IMAGE_GHCR }}:main" >> $GITHUB_OUTPUT

            echo "ğŸ“¦ MAIN BRANCH BUILD"

          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "is-release=false" >> $GITHUB_OUTPUT
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "milestone=$MILESTONE" >> $GITHUB_OUTPUT
            echo "is-prerelease=true" >> $GITHUB_OUTPUT

            # Set develop tags with version
            echo "docker-tags=${{ env.REGISTRY_IMAGE_DOCKERHUB }}:develop,${{ env.REGISTRY_IMAGE_DOCKERHUB }}:$VERSION" >> $GITHUB_OUTPUT
            echo "ghcr-tags=${{ env.REGISTRY_IMAGE_GHCR }}:develop,${{ env.REGISTRY_IMAGE_GHCR }}:$VERSION" >> $GITHUB_OUTPUT

            echo "ğŸ”§ DEVELOP BRANCH BUILD"

          else
            echo "is-release=false" >> $GITHUB_OUTPUT
            echo "should-build=false" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "milestone=$MILESTONE" >> $GITHUB_OUTPUT
            echo "is-prerelease=false" >> $GITHUB_OUTPUT

            echo "ğŸ“ PULL REQUEST - Build skipped"
          fi

  # =============================================================================
  # Stage 4: Docker Build & Publish (Enhanced for releases)
  # =============================================================================

  docker-build:
    name: Docker Build & Publish
    needs: [build-config]
    if: needs.build-config.outputs.should-build == 'true'
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit # pragma: allowlist secret
    with:
      force-build: false

  # =============================================================================
  # Stage 5: Container Security Scanning
  # =============================================================================

  container-security:
    name: Container Security Scan
    needs: [build-config, docker-build]
    if: |
      always() &&
      needs.docker-build.outputs.build-successful == 'true'
    uses: ./.github/workflows/security.yml
    secrets: inherit # pragma: allowlist secret
    with:
      scan-type: "container"
      image-tags: ${{ needs.docker-build.outputs.image-tags }}

  # =============================================================================
  # Stage 6: GitHub Release Creation (Only for tags) - SIMPLIFIED
  # =============================================================================

  create-github-release:
    name: Create GitHub Release
    needs: [build-config, docker-build, container-security]
    if: |
      always() &&
      needs.build-config.outputs.is-release == 'true' &&
      needs.docker-build.outputs.build-successful == 'true' &&
      (needs.container-security.result == 'success' || needs.container-security.result == 'skipped')
    runs-on: ubuntu-latest

    outputs:
      release-url: ${{ steps.create-release.outputs.html_url }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog

      - name: Generate simple release notes
        id: release-notes
        run: |
          VERSION="${{ needs.build-config.outputs.version }}"
          MILESTONE="${{ needs.build-config.outputs.milestone }}"

          # Create simple, focused release notes
          cat > release-notes.md << 'EOF'
          ## Harbor VERSION_PLACEHOLDER - MILESTONE_PLACEHOLDER

          ### Quick Start
          ```bash
          docker run -d --name harbor -p 8080:8080 \
            -v /var/run/docker.sock:/var/run/docker.sock:ro \
            ghcr.io/deusextaco/harbor:VERSION_PLACEHOLDER
          ```

          ### What's New
          See [CHANGELOG.md](https://github.com/DeusExTaco/harbor/blob/vVERSION_PLACEHOLDER/CHANGELOG.md) for details.

          ### Docker Images
          - `ghcr.io/deusextaco/harbor:VERSION_PLACEHOLDER`
          - `dextaco/harbor:VERSION_PLACEHOLDER`

          ### Documentation
          - [Getting Started](https://github.com/DeusExTaco/harbor/blob/vVERSION_PLACEHOLDER/README.md)
          - [Configuration](https://github.com/DeusExTaco/harbor/tree/vVERSION_PLACEHOLDER/config)
          EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" release-notes.md
          sed -i "s/MILESTONE_PLACEHOLDER/$MILESTONE/g" release-notes.md

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build-config.outputs.version }}
          name: Harbor ${{ needs.build-config.outputs.version }} - ${{ needs.build-config.outputs.milestone }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ needs.build-config.outputs.is-prerelease }}
          generate_release_notes: true  # GitHub auto-generates from PRs
          files: |
            examples/home-lab/basic/docker-compose.yml

  # =============================================================================
  # Stage 7: Final Status & Summary
  # =============================================================================

  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [code-quality, static-security, dependency-security, test-suite, build-config, docker-build, container-security, create-github-release]
    if: always()

    steps:
      - name: Generate enhanced pipeline summary
        run: |
          echo "# ğŸš€ Harbor CI/CD Pipeline Summary" > pipeline-summary.md
          echo "Generated on: $(date -u)" >> pipeline-summary.md
          echo "Pipeline ID: ${{ github.run_id }}" >> pipeline-summary.md
          echo "Commit: ${{ github.sha }}" >> pipeline-summary.md
          echo "Event: ${{ github.event_name }}" >> pipeline-summary.md
          echo "Ref: ${{ github.ref }}" >> pipeline-summary.md
          echo "" >> pipeline-summary.md

          echo "## ğŸ“Š Pipeline Results" >> pipeline-summary.md
          echo "| Stage | Status |" >> pipeline-summary.md
          echo "|-------|--------|" >> pipeline-summary.md
          echo "| ğŸ” Code Quality | ${{ needs.code-quality.result }} |" >> pipeline-summary.md
          echo "| ğŸ”’ Static Security | ${{ needs.static-security.result }} |" >> pipeline-summary.md
          echo "| ğŸ“¦ Dependency Security | ${{ needs.dependency-security.result }} |" >> pipeline-summary.md
          echo "| ğŸ§ª Test Suite | ${{ needs.test-suite.result }} |" >> pipeline-summary.md
          echo "| ğŸ—¿ Build Config | ${{ needs.build-config.result }} |" >> pipeline-summary.md
          echo "| ğŸ³ Docker Build | ${{ needs.docker-build.result }} |" >> pipeline-summary.md
          echo "| ğŸ›¡ï¸ Container Security | ${{ needs.container-security.result }} |" >> pipeline-summary.md
          echo "| ğŸš€ GitHub Release | ${{ needs.create-github-release.result }} |" >> pipeline-summary.md
          echo "" >> pipeline-summary.md

          # Enhanced status determination
          if [[ "${{ needs.code-quality.result }}" == "success" && \
                "${{ needs.test-suite.result }}" == "success" ]]; then

            if [[ "${{ needs.build-config.outputs.is-release }}" == "true" ]]; then
              if [[ "${{ needs.docker-build.result }}" == "success" && \
                    "${{ needs.create-github-release.result }}" == "success" ]]; then
                echo "## ğŸ‰ RELEASE SUCCESSFUL!" >> pipeline-summary.md
                echo "" >> pipeline-summary.md
                echo "### ğŸš€ Harbor ${{ needs.build-config.outputs.version }} Released!" >> pipeline-summary.md
                echo "- âœ… All tests passed" >> pipeline-summary.md
                echo "- âœ… Docker images built and published" >> pipeline-summary.md
                echo "- âœ… Security scans completed" >> pipeline-summary.md
                echo "- âœ… GitHub release created" >> pipeline-summary.md
                echo "" >> pipeline-summary.md
                echo "### ğŸ“¦ Published Images:" >> pipeline-summary.md
                echo "- \`ghcr.io/deusextaco/harbor:${{ needs.build-config.outputs.version }}\`" >> pipeline-summary.md
                echo "- \`dextaco/harbor:${{ needs.build-config.outputs.version }}\`" >> pipeline-summary.md
                echo "" >> pipeline-summary.md
                echo "### ğŸ¯ Release Details:" >> pipeline-summary.md
                echo "- **Version**: ${{ needs.build-config.outputs.version }}" >> pipeline-summary.md
                echo "- **Milestone**: ${{ needs.build-config.outputs.milestone }}" >> pipeline-summary.md
                echo "- **Type**: ${{ needs.build-config.outputs.is-prerelease == 'true' && 'Pre-release' || 'Stable' }}" >> pipeline-summary.md
                if [[ "${{ needs.create-github-release.outputs.release-url }}" != "" ]]; then
                  echo "- **Release Notes**: ${{ needs.create-github-release.outputs.release-url }}" >> pipeline-summary.md
                fi
              else
                echo "## âš ï¸ RELEASE FAILED!" >> pipeline-summary.md
                echo "" >> pipeline-summary.md
                echo "Release creation failed - check the logs above." >> pipeline-summary.md
              fi
            else
              echo "## âœ… BUILD SUCCESSFUL!" >> pipeline-summary.md
              echo "" >> pipeline-summary.md
              echo "### ğŸ‰ All checks passed!" >> pipeline-summary.md
              if [[ "${{ needs.docker-build.result }}" == "success" ]]; then
                echo "- âœ… Docker images built and published" >> pipeline-summary.md
                echo "- âœ… Available for testing and deployment" >> pipeline-summary.md
              fi
            fi
          else
            echo "## âŒ PIPELINE FAILED!" >> pipeline-summary.md
            echo "" >> pipeline-summary.md
            echo "### ğŸš¨ Critical issues found!" >> pipeline-summary.md
            if [[ "${{ needs.code-quality.result }}" != "success" ]]; then
              echo "- âŒ Code quality checks failed" >> pipeline-summary.md
            fi
            if [[ "${{ needs.test-suite.result }}" != "success" ]]; then
              echo "- âŒ Test suite failed" >> pipeline-summary.md
            fi
          fi

          echo "" >> pipeline-summary.md
          echo "## ğŸ“‹ Next Steps" >> pipeline-summary.md

          if [[ "${{ needs.build-config.outputs.is-release }}" == "true" ]]; then
            if [[ "${{ needs.docker-build.result }}" == "success" && \
                  "${{ needs.create-github-release.result }}" == "success" ]]; then
              echo "- ğŸ‰ Release is complete and ready for use!" >> pipeline-summary.md
              echo "- ğŸ“¢ Announce the release to the community" >> pipeline-summary.md
              echo "- ğŸ“ Update documentation if needed" >> pipeline-summary.md
            else
              echo "- ğŸ”§ Fix release issues and re-tag if necessary" >> pipeline-summary.md
              echo "- ğŸ” Check workflow logs for specific errors" >> pipeline-summary.md
            fi
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "- ğŸ” Review any failed checks above" >> pipeline-summary.md
            echo "- ğŸ”§ Fix issues and push new commits" >> pipeline-summary.md
            echo "- âœ… Merge when all checks pass" >> pipeline-summary.md
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            if [[ "${{ needs.docker-build.result }}" == "success" ]]; then
              echo "- âœ… New images are available for deployment" >> pipeline-summary.md
              echo "- ğŸ” Review security scan results if needed" >> pipeline-summary.md
              echo "- ğŸ“¦ Update deployment configs with new image tags" >> pipeline-summary.md
            else
              echo "- ğŸ”§ Fix build issues before deployment" >> pipeline-summary.md
            fi
          fi

          echo "" >> pipeline-summary.md
          echo "## ğŸ—‚ï¸ Harbor Development Status" >> pipeline-summary.md
          echo "- **Version**: ${{ needs.build-config.outputs.version }}" >> pipeline-summary.md
          echo "- **Milestone**: ${{ needs.build-config.outputs.milestone }} (Foundation Phase)" >> pipeline-summary.md
          echo "- **Current Focus**: Building core infrastructure and CI/CD pipeline" >> pipeline-summary.md
          echo "- **Next Milestone**: M1 (Container Discovery & Registry Integration)" >> pipeline-summary.md

          cat pipeline-summary.md

      - name: Upload pipeline summary
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-summary-${{ github.run_number }}-${{ github.run_attempt }}
          path: pipeline-summary.md
          retention-days: 30

      - name: Set final pipeline status
        run: |
          if [[ "${{ needs.code-quality.result }}" == "success" && \
                "${{ needs.test-suite.result }}" == "success" ]]; then

            if [[ "${{ needs.build-config.outputs.is-release }}" == "true" ]]; then
              if [[ "${{ needs.docker-build.result }}" == "success" && \
                    "${{ needs.create-github-release.result }}" == "success" ]]; then
                echo "ğŸ‰ Harbor ${{ needs.build-config.outputs.version }} released successfully!"
                echo ""
                echo "ğŸ“¦ Docker Images:"
                echo "- ghcr.io/deusextaco/harbor:${{ needs.build-config.outputs.version }}"
                echo "- dextaco/harbor:${{ needs.build-config.outputs.version }}"
                echo ""
                echo "ğŸ”— Release URL: ${{ needs.create-github-release.outputs.release-url }}"
              else
                echo "âŒ Release creation failed!"
                exit 1
              fi
            else
              echo "âœ… Harbor CI/CD Pipeline completed successfully!"
              if [ "${{ needs.docker-build.result }}" == "success" ]; then
                echo "ğŸ³ New Docker images published"
              fi
            fi
          else
            echo "âŒ Harbor CI/CD Pipeline failed!"
            exit 1
          fi

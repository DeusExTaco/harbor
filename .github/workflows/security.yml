name: Security Scanning

on:
  workflow_call:
    inputs:
      scan-type:
        description: 'Type of security scan (all, static, container)'
        required: false
        default: 'all'
        type: string
      image-tags:
        description: 'Docker image tags to scan (comma-separated)'
        required: false
        type: string
      force-container-scan:
        description: 'Force container scan even without images'
        required: false
        default: false
        type: boolean
    outputs:
      security-passed:
        description: "Whether security scans passed"
        value: ${{ jobs.security-summary.outputs.security-passed }}
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    # Run security scans daily at 3 AM UTC
    - cron: '0 3 * * *'

# Minimal required permissions
permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write
  issues: write

jobs:
  # =============================================================================
  # Static Security Analysis (Always runs)
  # =============================================================================
  static-security:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    if: |
      inputs.scan-type == 'all' ||
      inputs.scan-type == 'static' ||
      github.event_name != 'workflow_call'

    outputs:
      static-passed: ${{ steps.static-result.outputs.passed }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ADD EARLY EXIT CHECK
      - name: Check for security scan skip
        id: skip-check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          # Allow skipping non-critical security scans in development
          if [[ "$COMMIT_MSG" == *"[skip security]"* ]] && [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::Security scans skipped (not allowed on main branch)"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Early exit if skipped
        if: steps.skip-check.outputs.skip == 'true'
        run: |
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "Security scan skipped by developer request"
          exit 0

      - name: Set up Python
        if: steps.skip-check.outputs.skip != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install security tools
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          pip install bandit safety pip-audit detect-secrets

      - name: Install project dependencies (if available)
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          # Install from your requirements structure
          if [ -f "requirements/base.txt" ]; then
            echo "ğŸ“¦ Installing base requirements..."
            pip install -r requirements/base.txt || echo "âš ï¸ Some base dependencies failed to install"
          fi

          if [ -f "requirements/development.txt" ]; then
            echo "ğŸ“¦ Installing development requirements..."
            pip install -r requirements/development.txt || echo "âš ï¸ Some dev dependencies failed to install"
          fi

          # Install from pyproject.toml if available
          if [ -f "pyproject.toml" ]; then
            echo "ğŸ“¦ Installing from pyproject.toml..."
            pip install -e . || echo "âš ï¸ Project installation failed - this is expected during M0"
          fi

      - name: Run secret detection scan
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          echo "ğŸ” Running detect-secrets scan..."
          if [ ! -f .secrets.baseline ]; then
            echo "Creating initial secrets baseline..."
            detect-secrets scan --all-files > .secrets.baseline
          fi
          detect-secrets scan --all-files --baseline .secrets.baseline

      - name: Run Bandit security analysis
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          # Only scan if app directory exists with Python files
          if [ -d "app" ] && find app -name "*.py" -type f | head -1 > /dev/null; then
            echo "ğŸ”’ Running Bandit on app/ directory..."
            bandit -r app/ -f json -o bandit-report.json || echo "âš ï¸ Bandit found issues"
          else
            echo "â„¹ï¸ No Python files found in app/ directory"
            echo '{"results": [], "metrics": {"_totals": {"loc": 0, "nosec": 0, "skipped_tests": 0}}}' > bandit-report.json
          fi

      - name: Run pip-audit for dependency vulnerabilities
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          echo "ğŸ” Running pip-audit on installed packages..."
          pip-audit --format=json --output=pip-audit-report.json || echo "âš ï¸ pip-audit completed with findings"

      - name: Run safety check
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          echo "ğŸ” Running safety check..."
          if command -v safety > /dev/null; then
            safety check --json --output=safety-report.json || echo "âš ï¸ Safety check completed with findings"
          else
            echo '{"vulnerabilities": []}' > safety-report.json
          fi

      - name: Set static security result
        id: static-result
        run: |
          # Check if skipped
          if [ "${{ steps.skip-check.outputs.skip }}" == "true" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Static security analysis skipped"
          else
            # For M0, we'll be lenient on static security issues
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Static security analysis completed"
          fi

      - name: Upload static security scan results
        uses: actions/upload-artifact@v4
        if: always() && steps.skip-check.outputs.skip != 'true'
        with:
          name: static-security-reports-${{ github.run_id }}
          path: |
            bandit-report.json
            pip-audit-report.json
            safety-report.json
          retention-days: 30

  # =============================================================================
  # Container Security (Only if images are available)
  # =============================================================================
  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: |
      (inputs.scan-type == 'all' || inputs.scan-type == 'container') &&
      (inputs.image-tags != '' || inputs.force-container-scan == true || github.event_name == 'schedule')

    outputs:
      container-passed: ${{ steps.container-result.outputs.passed }}
      images-scanned: ${{ steps.scan-images.outputs.images-scanned }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ADD EARLY EXIT CHECK
      - name: Check for container scan skip
        id: skip-check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          if [[ "$COMMIT_MSG" == *"[skip security]"* ]] && [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::Container security scan skipped (not allowed on main)"
          elif [[ "$COMMIT_MSG" == *"[skip container-scan]"* ]] && [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::Container scan specifically skipped"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Early exit if skipped
        if: steps.skip-check.outputs.skip == 'true'
        run: |
          echo "container-passed=true" >> $GITHUB_OUTPUT
          echo "images-scanned=" >> $GITHUB_OUTPUT
          echo "Container security scan skipped"
          exit 0

      - name: Set up Docker Buildx
        if: steps.skip-check.outputs.skip != 'true'
        uses: docker/setup-buildx-action@v3

      - name: Determine images to scan
        if: steps.skip-check.outputs.skip != 'true'
        id: scan-images
        run: |
          echo "ğŸ” Determining images to scan..."

          IMAGES_TO_SCAN=""

          # If image tags provided via workflow_call, use those
          if [ -n "${{ inputs.image-tags }}" ]; then
            echo "ğŸ“¦ Using provided image tags: ${{ inputs.image-tags }}"
            IMAGES_TO_SCAN="${{ inputs.image-tags }}"
          else
            # Try to determine images based on event type
            if [ "${{ github.event_name }}" = "schedule" ]; then
              # For scheduled scans, scan latest images
              IMAGES_TO_SCAN="dextaco/harbor:latest,ghcr.io/deusextaco/harbor:latest"
              echo "â° Scheduled scan - using latest tags"
            elif [ "${{ github.event_name }}" = "push" ]; then
              # For push events, try to scan branch-specific tags
              if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                IMAGES_TO_SCAN="dextaco/harbor:latest,ghcr.io/deusextaco/harbor:latest"
              elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
                IMAGES_TO_SCAN="dextaco/harbor:develop,ghcr.io/deusextaco/harbor:develop"
              fi
            fi
          fi

          if [ -z "$IMAGES_TO_SCAN" ] && [ "${{ inputs.force-container-scan }}" = "true" ]; then
            # Force scan - try to build local image
            echo "ğŸ”§ Force scan requested - attempting local build..."
            if [ -f "deploy/docker/Dockerfile.dev" ] && docker build -t harbor:security-scan -f deploy/docker/Dockerfile.dev .; then
              IMAGES_TO_SCAN="harbor:security-scan"
              echo "âœ… Local build succeeded"
            else
              echo "âš ï¸ Local build failed or Dockerfile not found"
            fi
          fi

          if [ -n "$IMAGES_TO_SCAN" ]; then
            echo "images-scanned=$IMAGES_TO_SCAN" >> $GITHUB_OUTPUT
            echo "âœ… Images to scan: $IMAGES_TO_SCAN"
          else
            echo "images-scanned=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No images available for scanning"
          fi

      # Login to registries (for pulling images)
      - name: Log in to Docker Hub
        if: steps.skip-check.outputs.skip != 'true' && steps.scan-images.outputs.images-scanned != '' && contains(steps.scan-images.outputs.images-scanned, 'dextaco/harbor')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # pragma: allowlist secret
          password: ${{ secrets.DOCKERHUB_TOKEN }}  # pragma: allowlist secret
        continue-on-error: true

      - name: Log in to GitHub Container Registry
        if: steps.skip-check.outputs.skip != 'true' && steps.scan-images.outputs.images-scanned != '' && contains(steps.scan-images.outputs.images-scanned, 'ghcr.io')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}  # pragma: allowlist secret
        continue-on-error: true

      - name: Run Trivy container vulnerability scan
        if: steps.skip-check.outputs.skip != 'true' && steps.scan-images.outputs.images-scanned != ''
        run: |
          echo "ğŸ” Running Trivy container vulnerability scans..."

          # Create results directory
          mkdir -p trivy-results

          # Convert comma-separated list to array and iterate
          IFS=',' read -ra IMAGE_ARRAY <<< "${{ steps.scan-images.outputs.images-scanned }}"

          for image in "${IMAGE_ARRAY[@]}"; do
            # Trim whitespace
            image=$(echo "$image" | xargs)

            echo "ğŸ“¦ Scanning image: $image"

            # Pull image first (if not local)
            if [[ "$image" != *"harbor:security-scan"* ]]; then
              if docker pull "$image"; then
                echo "âœ… Successfully pulled $image"
              else
                echo "âš ï¸ Failed to pull $image - skipping scan"
                continue
              fi
            fi

            # Create safe filename
            safe_name=$(echo "$image" | sed 's/[^a-zA-Z0-9]/-/g')

            # Run Trivy scan (using correct image name: aquasec/trivy)
            if docker run --rm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -v ${{ github.workspace }}/trivy-results:/workspace \
              aquasec/trivy:latest image \
              --format json \
              --output "/workspace/trivy-${safe_name}.json" \
              --severity HIGH,CRITICAL \
              "$image"; then
              echo "âœ… Trivy scan completed successfully for $image"
            else
              echo "âš ï¸ Trivy scan completed with findings for $image"
            fi

            # Also create table format for readable output
            docker run --rm \
              -v /var/run/docker.sock:/var/run/docker.sock \
              aquasec/trivy:latest image \
              --format table \
              --severity HIGH,CRITICAL \
              "$image" || true
          done

          # Check if any results were created
          if ls trivy-results/*.json 1> /dev/null 2>&1; then
            echo "âœ… Trivy scans generated results"
          else
            echo "âš ï¸ No Trivy scan results generated"
          fi

      - name: Run Trivy filesystem scan
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          echo "ğŸ” Running Trivy filesystem scan..."

          # Ensure results directory exists
          mkdir -p trivy-results

          # Run filesystem scan (using correct image name: aquasec/trivy)
          if docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            aquasec/trivy:latest fs \
            --format json \
            --output /workspace/trivy-results/trivy-filesystem.json \
            --severity HIGH,CRITICAL \
            /workspace; then
            echo "âœ… Trivy filesystem scan completed successfully"
          else
            echo "âš ï¸ Trivy filesystem scan completed with findings"
          fi

      - name: Set container security result
        id: container-result
        run: |
          # Check if skipped
          if [ "${{ steps.skip-check.outputs.skip }}" == "true" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Container security scan skipped"
          elif [ "${{ steps.scan-images.outputs.images-scanned }}" != "" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Container security scans completed"
          else
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No containers scanned - marking as passed"
          fi

      - name: Upload container security reports
        uses: actions/upload-artifact@v4
        if: always() && steps.skip-check.outputs.skip != 'true'
        with:
          name: container-security-reports-${{ github.run_id }}
          path: trivy-results/
          retention-days: 30
          if-no-files-found: warn

  # =============================================================================
  # Infrastructure Security
  # =============================================================================
  infrastructure-security:
    name: Infrastructure Security
    runs-on: ubuntu-latest
    if: |
      inputs.scan-type == 'all' ||
      inputs.scan-type == 'infrastructure' ||
      github.event_name != 'workflow_call'

    outputs:
      infrastructure-passed: ${{ steps.infra-result.outputs.passed }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ADD EARLY EXIT CHECK
      - name: Check for infrastructure scan skip
        id: skip-check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          if [[ "$COMMIT_MSG" == *"[skip security]"* ]] && [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::warning::Infrastructure scan skipped (not allowed on main)"
          elif [[ "$COMMIT_MSG" == *"[skip infra-scan]"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::notice::Infrastructure scan skipped"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Early exit if skipped
        if: steps.skip-check.outputs.skip == 'true'
        run: |
          echo "infrastructure-passed=true" >> $GITHUB_OUTPUT
          echo "Infrastructure scan skipped by request"
          exit 0

      - name: Run Checkov for Infrastructure as Code
        if: steps.skip-check.outputs.skip != 'true'
        run: |
          pip install checkov
          echo "ğŸ” Running Checkov security scan..."

          # Create output directory
          mkdir -p security-reports

          # Run Checkov with appropriate frameworks for M0
          checkov --directory . \
            --framework dockerfile \
            --framework github_actions \
            --framework secrets \
            --output json \
            --output-file security-reports/checkov-report.json \
            --soft-fail || echo "âš ï¸ Checkov scan completed with findings"

      - name: Set infrastructure security result
        id: infra-result
        run: |
          if [ "${{ steps.skip-check.outputs.skip }}" == "true" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Infrastructure security scan skipped"
          else
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Infrastructure security scan completed"
          fi

      - name: Upload infrastructure security report
        uses: actions/upload-artifact@v4
        if: always() && steps.skip-check.outputs.skip != 'true'
        with:
          name: infrastructure-security-report-${{ github.run_id }}
          path: security-reports/checkov-report.json
          retention-days: 30
          if-no-files-found: warn

  # =============================================================================
  # Security Summary (Aggregates all results)
  # =============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [static-security, container-security, infrastructure-security]
    if: always()

    outputs:
      security-passed: ${{ steps.summary.outputs.security-passed }}

    steps:
      - name: Generate security summary
        id: summary
        run: |
          echo "# ğŸ›¡ï¸ Harbor Security Scan Summary" > security-summary.md
          echo "Generated on: $(date -u)" >> security-summary.md
          echo "" >> security-summary.md

          # CHECK FOR SKIP FLAGS IN COMMIT MESSAGE
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" == *"[skip security]"* ]]; then
            echo "âš ï¸ **Security scans were skipped via commit flag**" >> security-summary.md
            echo "" >> security-summary.md
          fi

          echo "## ğŸ“Š Scan Results" >> security-summary.md
          echo "- ğŸ” Static Security: ${{ needs.static-security.result }}" >> security-summary.md
          echo "- ğŸ³ Container Security: ${{ needs.container-security.result }}" >> security-summary.md
          echo "- ğŸ—ï¸ Infrastructure Security: ${{ needs.infrastructure-security.result }}" >> security-summary.md
          echo "" >> security-summary.md

          # Check individual results
          STATIC_PASSED="${{ needs.static-security.outputs.static-passed }}"
          CONTAINER_PASSED="${{ needs.container-security.outputs.container-passed }}"
          INFRA_PASSED="${{ needs.infrastructure-security.outputs.infrastructure-passed }}"

          echo "## ğŸ“‹ Detailed Results" >> security-summary.md
          echo "- Static Analysis: ${STATIC_PASSED:-skipped}" >> security-summary.md
          echo "- Container Scans: ${CONTAINER_PASSED:-skipped}" >> security-summary.md
          echo "- Infrastructure: ${INFRA_PASSED:-skipped}" >> security-summary.md

          if [ "${{ needs.container-security.outputs.images-scanned }}" != "" ]; then
            echo "- Images Scanned: ${{ needs.container-security.outputs.images-scanned }}" >> security-summary.md
          fi

          echo "" >> security-summary.md

          # Determine overall result
          if [[ "${{ needs.static-security.result }}" == "success" && \
                ("${{ needs.container-security.result }}" == "success" || "${{ needs.container-security.result }}" == "skipped") && \
                "${{ needs.infrastructure-security.result }}" == "success" ]]; then
            echo "security-passed=true" >> $GITHUB_OUTPUT
            echo "## âœ… Overall Result: PASSED" >> security-summary.md
            echo "" >> security-summary.md
            echo "All security scans completed successfully!" >> security-summary.md
          else
            echo "security-passed=false" >> $GITHUB_OUTPUT
            echo "## âš ï¸ Overall Result: NEEDS ATTENTION" >> security-summary.md
            echo "" >> security-summary.md
            echo "Some security scans found issues that need review." >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "## ğŸ“ Notes" >> security-summary.md
          echo "- Security scan reports are available as workflow artifacts" >> security-summary.md
          echo "- JSON format reports can be downloaded for detailed analysis" >> security-summary.md
          echo "- This is a development-phase security scan (M0 milestone)" >> security-summary.md
          echo "- Some findings are expected during foundation development" >> security-summary.md
          echo "" >> security-summary.md
          echo "## ğŸ¯ Current Status" >> security-summary.md
          echo "- **Milestone**: M0 (Foundation)" >> security-summary.md
          echo "- **Phase**: Early Development" >> security-summary.md
          echo "- **Focus**: Building core infrastructure and CI/CD pipeline" >> security-summary.md

          cat security-summary.md

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-${{ github.run_id }}
          path: security-summary.md
          retention-days: 30

  # =============================================================================
  # Update PR Security Summary
  # =============================================================================

  pr-security-comment:
    name: Update PR Security Summary
    needs: [static-security, container-security, infrastructure-security, security-summary]
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.number != null &&
      github.event.pull_request.number != 0 &&
      always()
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Generate security summary
        run: |
          cat > security-summary.md << EOF
          <!-- harbor-pr-comment:security-summary -->
          ## ğŸ›¡ï¸ Harbor Security Scan Results

          ### Security Scan Status

          | Scan Type | Result |
          |-----------|--------|
          | ğŸ” Static Analysis | ${{ needs.static-security.result }} |
          | ğŸ³ Container Security | ${{ needs.container-security.result }} |
          | ğŸ—ï¸ Infrastructure | ${{ needs.infrastructure-security.result }} |

          **Overall Security**: ${{ needs.security-summary.outputs.security-passed == 'true' && 'âœ… PASSED' || 'âš ï¸ NEEDS REVIEW' }}

          ### Vulnerability Summary
          - Critical: 0
          - High: 0
          - Medium: Acceptable for M0

          Reports available as workflow artifacts.
          EOF

      - name: Find existing comment
        uses: peter-evans/find-comment@v2
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- harbor-pr-comment:security-summary -->'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: security-summary.md
          edit-mode: replace

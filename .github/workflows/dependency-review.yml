name: 'Dependency Review'

on:
  workflow_call:
    outputs:
      dependency-check-passed:
        description: "Whether dependency checks passed"
        value: ${{ jobs.dependency-summary.outputs.dependency-passed }}
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'requirements/**'
      - 'pyproject.toml'
      - '.github/workflows/dependency-review.yml'
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'requirements/**'
      - 'pyproject.toml'
  schedule:
    # Run dependency review weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # =============================================================================
  # GitHub Dependency Review (PR only)
  # =============================================================================
  github-dependency-review:
    name: GitHub Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # Allow moderate vulnerabilities during M0 development
          fail-on-severity: critical

          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, PSF-2.0, Python-2.0, 0BSD, Unlicense

          # Comment summary in PR only on failure
          comment-summary-in-pr: on-failure

          # Only check runtime dependencies for now
          fail-on-scopes: runtime

          # Base and head refs for comparison
          base-ref: ${{ github.event.pull_request.base.sha }}
          head-ref: ${{ github.event.pull_request.head.sha }}

  # =============================================================================
  # Security Vulnerability Scan
  # =============================================================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    outputs:
      scan-passed: ${{ steps.scan-result.outputs.passed }}
      vulnerability-count: ${{ steps.count-vulns.outputs.count }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install security scanning tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety

      - name: Install Harbor dependencies
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Installing Harbor dependencies for security scan..."
          echo "â„¹ï¸  Note: This is M0 development - some dependency issues are expected"

          # Install base requirements with fallback handling
          if [ -f "requirements/base.txt" ]; then
            echo "ðŸ“‹ Installing base requirements..."
            if pip install -r requirements/base.txt; then
              echo "âœ… Base requirements installed successfully"
            else
              echo "âš ï¸ Some base requirements failed - trying essential packages only"
              # Install critical packages individually to maximize success
              pip install fastapi uvicorn sqlalchemy pydantic || echo "Core packages failed"
              pip install httpx docker || echo "Integration packages failed"
              pip install structlog prometheus-client || echo "Monitoring packages failed"
              pip install argon2-cffi cryptography || echo "Security packages failed"
            fi
          else
            echo "âš ï¸ requirements/base.txt not found"
          fi

          # Try to install some packages that are definitely needed for scanning
          echo "ðŸ”§ Ensuring we have scannable packages..."
          pip install --no-deps requests urllib3 certifi || echo "Basic HTTP packages failed"

          echo "ðŸ“Š Installed packages summary:"
          pip list --format=columns | head -20 || echo "Package list unavailable"

          echo "âœ… Dependency installation completed (errors expected during M0 development)"

      - name: Run pip-audit vulnerability scan
        id: pip-audit
        continue-on-error: true
        run: |
          echo "ðŸ” Running pip-audit vulnerability scan..."

          # Create empty report file as fallback
          echo '{"vulnerabilities": []}' > pip-audit-report.json

          # Run pip-audit
          if pip-audit --format=json --output=pip-audit-report.json --progress-spinner=off; then
            echo "âœ… pip-audit completed successfully"
          else
            echo "âš ï¸ pip-audit found vulnerabilities or encountered errors"
            echo "pip-audit-failed=true" >> $GITHUB_ENV
          fi

          # Always try to generate human-readable report
          pip-audit --format=columns --output=pip-audit-readable.txt --progress-spinner=off 2>/dev/null || echo "Basic scan completed"

      - name: Run Safety vulnerability scan
        id: safety
        continue-on-error: true
        run: |
          echo "ðŸ›¡ï¸ Running Safety vulnerability scan..."

          # Create empty report file as fallback
          echo '{"vulnerabilities": []}' > safety-report.json

          # Run safety scan
          if safety check --json --output=safety-report.json; then
            echo "âœ… Safety completed successfully"
          else
            echo "âš ï¸ Safety found vulnerabilities or encountered errors"
            echo "safety-failed=true" >> $GITHUB_ENV
          fi

      - name: Count and analyze vulnerabilities
        id: count-vulns
        shell: bash
        run: |
          set +e  # Don't exit on errors in this step
          echo "ðŸ“Š Analyzing vulnerability scan results..."

          TOTAL_VULNS=0
          CRITICAL_VULNS=0
          HIGH_VULNS=0
          MODERATE_VULNS=0

          # Parse pip-audit results with better error handling
          if [ -f "pip-audit-report.json" ] && [ -s "pip-audit-report.json" ]; then
            echo "ðŸ” Analyzing pip-audit results..."
            AUDIT_RESULTS=$(python3 -c "
            import json
            import sys
            try:
                with open('pip-audit-report.json', 'r') as f:
                    data = json.load(f)
                    vulns = data.get('vulnerabilities', [])
                    total = len(vulns)
                    # Simple severity counting (pip-audit format may vary)
                    critical = 0
                    high = 0
                    moderate = 0
                    for vuln in vulns:
                        vuln_str = str(vuln).lower()
                        if 'critical' in vuln_str:
                            critical += 1
                        elif 'high' in vuln_str:
                            high += 1
                        elif 'moderate' in vuln_str or 'medium' in vuln_str:
                            moderate += 1
                    print(f'{total},{critical},{high},{moderate}')
            except Exception as e:
                print('0,0,0,0')
            " 2>/dev/null || echo "0,0,0,0")

            IFS=',' read -r audit_total audit_crit audit_high audit_mod <<< "$AUDIT_RESULTS"
            TOTAL_VULNS=$((TOTAL_VULNS + audit_total))
            CRITICAL_VULNS=$((CRITICAL_VULNS + audit_crit))
            HIGH_VULNS=$((HIGH_VULNS + audit_high))
            MODERATE_VULNS=$((MODERATE_VULNS + audit_mod))

            echo "ðŸ“Š pip-audit: $audit_total vulnerabilities ($audit_crit critical, $audit_high high, $audit_mod moderate)"
          else
            echo "âš ï¸ No pip-audit results to analyze"
          fi

          # Parse Safety results with better error handling
          if [ -f "safety-report.json" ] && [ -s "safety-report.json" ]; then
            echo "ðŸ” Analyzing Safety results..."
            SAFETY_RESULTS=$(python3 -c "
            import json
            try:
                with open('safety-report.json', 'r') as f:
                    data = json.load(f)
                    vulns = data.get('vulnerabilities', [])
                    total = len(vulns)
                    print(total)
            except Exception:
                print(0)
            " 2>/dev/null || echo "0")

            TOTAL_VULNS=$((TOTAL_VULNS + SAFETY_RESULTS))
            echo "ðŸ“Š Safety: $SAFETY_RESULTS vulnerabilities"
          else
            echo "âš ï¸ No Safety results to analyze"
          fi

          # Handle potential uninitialized variables
          TOTAL_VULNS=${TOTAL_VULNS:-0}
          CRITICAL_VULNS=${CRITICAL_VULNS:-0}
          HIGH_VULNS=${HIGH_VULNS:-0}
          MODERATE_VULNS=${MODERATE_VULNS:-0}

          echo ""
          echo "ðŸ“ˆ Final Vulnerability Summary:"
          echo "- Total: $TOTAL_VULNS"
          echo "- Critical: $CRITICAL_VULNS"
          echo "- High: $HIGH_VULNS"
          echo "- Moderate: $MODERATE_VULNS"
          echo ""

          # Export for other jobs
          echo "count=$TOTAL_VULNS" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL_VULNS" >> $GITHUB_OUTPUT
          echo "high=$HIGH_VULNS" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE_VULNS" >> $GITHUB_OUTPUT

      - name: Evaluate security scan results
        id: scan-result
        shell: bash
        run: |
          set +e  # Don't exit on errors

          # Get vulnerability counts with defaults
          TOTAL_VULNS="${{ steps.count-vulns.outputs.count }}"
          CRITICAL_VULNS="${{ steps.count-vulns.outputs.critical }}"
          HIGH_VULNS="${{ steps.count-vulns.outputs.high }}"
          MODERATE_VULNS="${{ steps.count-vulns.outputs.moderate }}"

          # Set defaults if empty
          TOTAL_VULNS=${TOTAL_VULNS:-0}
          CRITICAL_VULNS=${CRITICAL_VULNS:-0}
          HIGH_VULNS=${HIGH_VULNS:-0}
          MODERATE_VULNS=${MODERATE_VULNS:-0}

          echo "ðŸ” Evaluating security scan results..."
          echo "ðŸ“Š Vulnerability counts:"
          echo "  - Total: $TOTAL_VULNS"
          echo "  - Critical: $CRITICAL_VULNS"
          echo "  - High: $HIGH_VULNS"
          echo "  - Moderate: $MODERATE_VULNS"
          echo ""

          # Check for scan failures
          SCAN_FAILURES=""
          if [ "${pip-audit-failed:-false}" = "true" ]; then
            SCAN_FAILURES="$SCAN_FAILURES pip-audit"
          fi
          if [ "${safety-failed:-false}" = "true" ]; then
            SCAN_FAILURES="$SCAN_FAILURES safety"
          fi

          if [ -n "$SCAN_FAILURES" ]; then
            echo "âš ï¸ Some security tools failed: $SCAN_FAILURES"
            echo "This may indicate dependency installation issues during M0 development"
          fi

          # M0 Development Phase Security Policy
          echo "ðŸ“‹ Applying M0 development security policy..."

          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ CRITICAL vulnerabilities found: $CRITICAL_VULNS"
            echo "ðŸš« Critical vulnerabilities must be fixed before merge"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "failure-reason=critical-vulnerabilities" >> $GITHUB_OUTPUT
          elif [ "$HIGH_VULNS" -gt 5 ]; then
            echo "âŒ Too many HIGH vulnerabilities: $HIGH_VULNS (development limit: 5)"
            echo "ðŸ”§ Please update dependencies to reduce high severity vulnerabilities"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "failure-reason=high-vulnerability-count" >> $GITHUB_OUTPUT
          elif [ "$TOTAL_VULNS" -gt 50 ]; then
            echo "âŒ Excessive total vulnerabilities: $TOTAL_VULNS (development limit: 50)"
            echo "ðŸ”§ Dependency set needs security review"
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "failure-reason=excessive-vulnerabilities" >> $GITHUB_OUTPUT
          else
            echo "âœ… Security scan passed M0 development criteria"
            if [ "$TOTAL_VULNS" -gt 0 ]; then
              echo "ðŸ“Š Total vulnerabilities: $TOTAL_VULNS (within acceptable range for development)"
              if [ "$MODERATE_VULNS" -gt 0 ]; then
                echo "â„¹ï¸  Moderate vulnerabilities: $MODERATE_VULNS (acceptable during M0)"
              fi
            else
              echo "ðŸŽ‰ No vulnerabilities detected!"
            fi
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "failure-reason=" >> $GITHUB_OUTPUT
          fi

      - name: Upload vulnerability scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-reports-${{ github.run_id }}
          path: |
            pip-audit-report.json
            pip-audit-readable.txt
            safety-report.json
          retention-days: 30

  # =============================================================================
  # License Compliance Check
  # =============================================================================
  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest

    outputs:
      license-passed: ${{ steps.license-result.outputs.passed }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install license checking tools
        run: |
          pip install pip-licenses licensecheck

      - name: Install dependencies for license check
        run: |
          echo "ðŸ“¦ Installing dependencies for license analysis..."

          # Install base dependencies
          if [ -f "requirements/base.txt" ]; then
            pip install -r requirements/base.txt || echo "Some packages failed"
          fi

      - name: Generate license report
        run: |
          echo "ðŸ“‹ Generating license compliance report..."

          # Generate comprehensive license report
          pip-licenses --format=json --output-file=license-report.json --with-urls --with-description || echo "License report completed"

          # Generate human-readable summary
          echo "ðŸ“Š License Summary:" > license-summary.txt
          echo "==================" >> license-summary.txt
          pip-licenses --format=plain >> license-summary.txt || echo "Summary completed"

          # Show summary in logs
          echo "ðŸ“‹ Current License Summary:"
          pip-licenses --summary || echo "Summary completed"

      - name: Validate license compliance
        id: license-result
        run: |
          echo "ðŸ” Validating license compliance..."

          # Define allowed licenses (permissive only) - matching dependency-review action
          ALLOWED_LICENSES="MIT|Apache|BSD|ISC|Python|PSF"

          # Check for problematic licenses
          PROBLEMATIC_COUNT=0

          if command -v pip-licenses &> /dev/null; then
            # Count packages with non-allowed licenses
            PROBLEMATIC_COUNT=$(pip-licenses --format=plain --no-version | \
              grep -v -E "$ALLOWED_LICENSES" | \
              grep -v "License" | \
              grep -v "^$" | \
              wc -l)
          fi

          echo "ðŸ“Š License compliance results:"
          echo "- Problematic licenses found: $PROBLEMATIC_COUNT"

          if [ "$PROBLEMATIC_COUNT" -gt 5 ]; then
            echo "âŒ Too many packages with non-standard licenses: $PROBLEMATIC_COUNT"
            echo "Please review license compatibility"
            echo "passed=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… License compliance acceptable for M0 development"
            echo "Non-standard licenses: $PROBLEMATIC_COUNT (under limit of 5)"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-reports-${{ github.run_id }}
          path: |
            license-report.json
            license-summary.txt
          retention-days: 30

  # =============================================================================
  # Dependency Summary and Status
  # =============================================================================
  dependency-summary:
    name: Dependency Review Summary
    runs-on: ubuntu-latest
    needs: [github-dependency-review, security-scan, license-compliance]
    if: always()

    outputs:
      dependency-passed: ${{ steps.final-result.outputs.dependency-passed }}

    steps:
      - name: Collect results
        id: collect-results
        run: |
          echo "ðŸ“Š Collecting dependency review results..."

          # Get individual job results
          GITHUB_REVIEW_RESULT="${{ needs.github-dependency-review.result }}"
          SECURITY_SCAN_RESULT="${{ needs.security-scan.result }}"
          LICENSE_CHECK_RESULT="${{ needs.license-compliance.result }}"

          # Get detailed outputs
          SECURITY_PASSED="${{ needs.security-scan.outputs.scan-passed }}"
          LICENSE_PASSED="${{ needs.license-compliance.outputs.license-passed }}"
          VULN_COUNT="${{ needs.security-scan.outputs.vulnerability-count }}"

          echo "github-review=$GITHUB_REVIEW_RESULT" >> $GITHUB_OUTPUT
          echo "security-scan=$SECURITY_SCAN_RESULT" >> $GITHUB_OUTPUT
          echo "license-check=$LICENSE_CHECK_RESULT" >> $GITHUB_OUTPUT
          echo "security-passed=$SECURITY_PASSED" >> $GITHUB_OUTPUT
          echo "license-passed=$LICENSE_PASSED" >> $GITHUB_OUTPUT
          echo "vulnerability-count=$VULN_COUNT" >> $GITHUB_OUTPUT

      - name: Generate summary report
        run: |
          echo "# ðŸ”’ Harbor Dependency Review Summary" > dependency-summary.md
          echo "" >> dependency-summary.md
          echo "**Generated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> dependency-summary.md
          echo "**Event**: ${{ github.event_name }}" >> dependency-summary.md
          echo "**Branch**: ${{ github.ref_name }}" >> dependency-summary.md
          echo "**Milestone**: M0 (Foundation)" >> dependency-summary.md
          echo "" >> dependency-summary.md

          echo "## ðŸ“Š Review Results" >> dependency-summary.md
          echo "" >> dependency-summary.md

          # GitHub Dependency Review
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ needs.github-dependency-review.result }}" = "success" ]; then
              echo "- âœ… **GitHub Dependency Review**: Passed" >> dependency-summary.md
            else
              echo "- âŒ **GitHub Dependency Review**: Failed" >> dependency-summary.md
            fi
          else
            echo "- â­ï¸ **GitHub Dependency Review**: Skipped (not a PR)" >> dependency-summary.md
          fi

          # Security Scan
          if [ "${{ needs.security-scan.result }}" = "success" ]; then
            if [ "${{ steps.collect-results.outputs.security-passed }}" = "true" ]; then
              echo "- âœ… **Security Scan**: Passed" >> dependency-summary.md
            else
              echo "- âš ï¸ **Security Scan**: Completed with warnings" >> dependency-summary.md
            fi
          else
            echo "- âŒ **Security Scan**: Failed" >> dependency-summary.md
          fi

          # License Check
          if [ "${{ needs.license-compliance.result }}" = "success" ]; then
            if [ "${{ steps.collect-results.outputs.license-passed }}" = "true" ]; then
              echo "- âœ… **License Compliance**: Passed" >> dependency-summary.md
            else
              echo "- âš ï¸ **License Compliance**: Needs review" >> dependency-summary.md
            fi
          else
            echo "- âŒ **License Compliance**: Failed" >> dependency-summary.md
          fi

          echo "" >> dependency-summary.md
          echo "## ðŸ“ˆ Security Details" >> dependency-summary.md
          echo "" >> dependency-summary.md
          echo "- **Vulnerabilities Found**: ${{ steps.collect-results.outputs.vulnerability-count }}" >> dependency-summary.md
          echo "- **Scan Status**: ${{ steps.collect-results.outputs.security-passed }}" >> dependency-summary.md
          echo "" >> dependency-summary.md

          echo "## ðŸ“‹ M0 Development Policy" >> dependency-summary.md
          echo "" >> dependency-summary.md
          echo "During M0 milestone development:" >> dependency-summary.md
          echo "- Critical vulnerabilities: âŒ **Block**" >> dependency-summary.md
          echo "- High vulnerabilities: âš ï¸ **Limit to 5**" >> dependency-summary.md
          echo "- Moderate vulnerabilities: âœ… **Allow**" >> dependency-summary.md
          echo "- License compatibility: âœ… **Require permissive licenses**" >> dependency-summary.md
          echo "" >> dependency-summary.md

          echo "## ðŸ“„ Reports Available" >> dependency-summary.md
          echo "" >> dependency-summary.md
          echo "The following detailed reports are available as workflow artifacts:" >> dependency-summary.md
          echo "- \`security-scan-reports-${{ github.run_id }}\` - Vulnerability scan results" >> dependency-summary.md
          echo "- \`license-reports-${{ github.run_id }}\` - License compliance analysis" >> dependency-summary.md
          echo "" >> dependency-summary.md

          # Display the summary
          cat dependency-summary.md

      - name: Determine final result
        id: final-result
        run: |
          # Final result determination for M0 milestone
          GITHUB_OK="true"
          SECURITY_OK="${{ steps.collect-results.outputs.security-passed }}"
          LICENSE_OK="${{ steps.collect-results.outputs.license-passed }}"

          # For PRs, check GitHub dependency review
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ "${{ needs.github-dependency-review.result }}" != "success" ]; then
              GITHUB_OK="false"
            fi
          fi

          echo "ðŸ” Final result determination:"
          echo "- GitHub Review OK: $GITHUB_OK"
          echo "- Security Scan OK: $SECURITY_OK"
          echo "- License Check OK: $LICENSE_OK"

          if [ "$GITHUB_OK" = "true" ] && [ "$SECURITY_OK" = "true" ] && [ "$LICENSE_OK" = "true" ]; then
            echo "âœ… Overall dependency review: PASSED"
            echo "dependency-passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Overall dependency review: FAILED"
            echo "Please review the individual check results above"
            echo "dependency-passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload final summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-review-summary-${{ github.run_id }}
          path: dependency-summary.md
          retention-days: 30

      - name: Comment PR with summary (if PR)
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('dependency-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
